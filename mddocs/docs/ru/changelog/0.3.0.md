# 0.3.0 (2025-07-04)

## Новые возможности

- Улучшена поддержка `openlineage-airflow` ([#210](https://github.com/MobileTeleSystems/data-rentgen/issues/210)).

  Раньше мы отслеживали только события начала/окончания DAG и Task, но не отслеживали связи между данными.
  Теперь мы сохраняем связи между данными, создаваемые операторами Airflow, такими как `SQLExecuteQueryOperator`.

- Добавлена поддержка `openlineage-flink` ([#214](https://github.com/MobileTeleSystems/data-rentgen/issues/214)).
- Добавлена поддержка `openlineage-hive` ([#245](https://github.com/MobileTeleSystems/data-rentgen/issues/245)).
- Добавлена поддержка `openlineage-dbt` ([#223](https://github.com/MobileTeleSystems/data-rentgen/issues/223)).
- Добавлена детализация `DATASET` для `GET /api/datasets/lineage` ([#235](https://github.com/MobileTeleSystems/data-rentgen/issues/235)).
- Сохранение SQL-запросов, полученных от интеграций OpenLineage. ([#213](https://github.com/MobileTeleSystems/data-rentgen/issues/213), [#218](https://github.com/MobileTeleSystems/data-rentgen/issues/218)).

## Критические изменения

- Изменен тип `Output.type` в ответе `GET /api/*/lineage` с `Enum` на `List[Enum]` ([#222](https://github.com/MobileTeleSystems/data-rentgen/issues/222)).

### Примеры ENUM в ответе о связях между данными

=== До

  ```python
  {
      "nodes": {...},
      "relations": {
          "outputs": [
              {
              "from": {"kind": "JOB", "id": 3981},
              "to": {"kind": "DATASET", "id": 8400},
              "types": "OVERWRITE",  # <---
              ...
          ]
      },
  }
  ```

=== После

  ```python
  {
      "nodes": {...},
      "relations": {
          "outputs": [
              {
              "from": {"kind": "JOB", "id": 3981},
              "to": {"kind": "DATASET", "id": 8400},
              "types": ["OVERWRITE", "DROP", "TRUNCATE"],  # <---
              ...
          ]
      },
  }
  ```

  Мы используем схему выходных данных, если она доступна, в противном случае используем схему входных данных.

- `Input.schema` и `Output.schema` перенесены в `Dataset.schema` в ответе `GET /api/*/lineage` ([#249](https://github.com/MobileTeleSystems/data-rentgen/issues/249)).

### Примеры схемы в ответе о связях между данными

=== До

  ```python
  {
      "nodes": {
          "datasets": {
              "8400": {
                  "id": "8400",
                  "location": {...},
                  "name": "dataset_name",
                  ...
          }

      },
      "relations": {
          "outputs": [
              {
              "from": {"kind": "JOB", "id": 3981},
              "to": {"kind": "DATASET", "id": 8400},
              "types": "OVERWRITE",
              "schema": {  # <---
                  "id": "10062",
                  "fields": [ ... ],
                  "relevance_type": "EXACT_MATCH"
              ]
          ]
      },
  }
  ```

=== После

  ```python
  {
      "nodes": {
          "datasets": {
              "8400": {
                  "id": "25896",
                  "location": {...},
                  "name": "dataset_name",
                  "schema": {  # <---
                      "id": "10062",
                      "fields": [...],
                      "relevance_type": "EXACT_MATCH"
                  },
                  ...
              }
          }
          ...
      },
      "relations": {
          "outputs": [
              {
              "from": {"kind": "JOB", "id": 3981},
              "to": {"kind": "DATASET", "id": 8400},
              "types": ["OVERWRITE", "DROP", "TRUNCATE"],
              ...
          ]
      },
  }
  ```

## Улучшения

- Добавлен скрипт `cleanup_partitions.py` для автоматической очистки старых партиций таблиц ([#254](https://github.com/MobileTeleSystems/data-rentgen/issues/254)).
- Добавлен скрипт `data_rentgen.db.seed`, который создает примеры данных в базе данных ([#257](https://github.com/MobileTeleSystems/data-rentgen/issues/257)).
- Ускорено получение объектов `Run` и `Operation` из базы данных по id ([#247](https://github.com/MobileTeleSystems/data-rentgen/issues/247)).
- Ускорено получение событий OpenLineage из Kafka ([#236](https://github.com/MobileTeleSystems/data-rentgen/issues/236)).
- Сделана более надежной обработка сообщений в консьюмере ([#204](https://github.com/MobileTeleSystems/data-rentgen/issues/204)).

  Ранее некорректно сформированные события OpenLineage (JSON) приводили к пропуску всего пакета сообщений, прочитанных из Kafka.
  Теперь сообщения анализируются по отдельности, а некорректные отправляются обратно в топик Kafka `input.runs__malformed`.
- Улучшено сохранение данных о связях для длительных операций ([#253](https://github.com/MobileTeleSystems/data-rentgen/issues/253)).

### Описание

  Ранее, если операция выполнялась в течение длительного времени (более дня, потоковые задачи Flink могут легко работать месяцами или годами), и граф связей строился за последний день, то задача/запуск/операция Flink отсутствовали в графе.

  Это происходило потому, что мы создавали связи ввода/вывода/столбцов в начале операции, и события `RUNNING` той же операции (контрольные точки) просто обновляли статистику в той же строке.

  Теперь мы создаем новую строку для связей ввода/вывода/столбцов также и для событий контрольных точек. Но только одну строку для каждого часа с момента запуска операции, так как увеличение количества строк замедляет построение графа связей.

  Для короткоживущих операций (большинство пакетных операций занимает менее часа) поведение остается неизменным.

## Исправления ошибок

- Исправлен шаблон URL для DAG и Task в Airflow 3.x ([#227](https://github.com/MobileTeleSystems/data-rentgen/issues/227)).
